# 4.14 外包项目问题


## 消费的时候怎么区分是钉钉还是微信的
嗯，是这样的。我们在使用消息推送平台的时候，是需要创建出模板的。在**模板里是得需要指定是什么渠道**（钉钉还是微信），我们写入MQ的数据，是带有这条消息的渠道是什么，消息类型是什么的。所以消费的时候是能根据消息的字段区分开来的。

## 怎么保证消费顺序性还能批量消费
对于发消息这个场景不需要保证MQ消费的顺序性，所以在austin项目里是没有做的。实际上，绝大多数业务场景都**不需要保证强顺序性**。比如我之前处理过的广告系统，订单的状态比如有 支付、确认收货、完成等等，而订单下还有计费、退款的消息报。

理论上来说，**支付的消息报肯定要比退款消息报先到嘛**，但程序处理的过程中可不一定的嘛，所以在这边也**是有消费顺序的问题。**
但在广告场景下**不是「强顺序」**的，只要保证最终一致性就好了。所以我们这边处理「乱序」消息的实现是这样的：

- 宽表：将每一个订单状态，单独分出一个或多个独立的字段。消息来时只更新对应的字段就好，消息只会存在短暂的状态不一致问题，但是状态最终是一致的
- 消息补偿机制：另一个进行消费相同topic的数据，消息落盘，延迟处理。将消息与DB进行对比，如果发现数据不一致，再重新发送消息至主进程处理

还有部分场景，可能我们只需要把**相同userId/orderId发送到相同的partition**（因为一个partition由一个Consumer消费），又能解决大部分消费顺序的问题了呢。 （这种一定程序上是**能满足批量**，但并不是强顺序的）

而要做到**强顺序，就只能一个partition，一个消费者去消费了**。

## 怎么做优雅停机
所谓「优雅停机」就是关闭的时候**先将自己需要处理的内容处理完了**，之后才关闭。如果你直接`kill -9`，是没有「优雅」这一说法的，神仙都救不了。

**1**、在**网络层**：TCP有四次挥手、TCP KeepAlive、HTTP KeepAlive 让连接 优雅地关闭，避免很多报错。

**2**、在**Java**里边通过Runtime.getRuntime().addShutdownHook()注册事件，当虚拟机关闭的前调用该方法的具体逻辑进行**善后**。

**3**、在**Spring**里边执行了ApplicationContext 的close之后，只要我们Bean配置了destroy策略，那Spring在关闭之前也会先执行我们的已实现好的destroy方法

**4**、在**Tomcat**容器提供了几种关闭的姿势，先暂停请求，选择等待N秒才完全关闭容器。

**5**、在**Java线程池**提供了shutdown和shutdownNow供我们关闭线程，显然**shutdown**是优雅关闭线程池的方法。


> 原文: <https://www.yuque.com/u37247843/dg9569/cd6xi74qvyfsx8c3>